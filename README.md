# ScreenTranslate (Gemini API) — 操作ガイド（現状版）

> 最終更新: 2025-10-14 15:55:32

このドキュメントは、**現在の実装がサポートしている操作**をまとめたものです。  
矩形選択・**自由選択（ラッソ）**・画像D&D/サムネイル選択・連結・原文保持・口調/話者プリセット・前面固定・キャンセルなど、
実際のコードに合わせて更新しています。

---

## 目次
- [特徴](#特徴)
- [動作環境](#動作環境)
- [インストール](#インストール)
- [APIキー/モデルの設定](#apiキーモデルの設定)
- [起動方法](#起動方法)
- [基本操作フロー](#基本操作フロー)
- [ホットキー（既定）](#ホットキー既定)
- [GUIパネル](#guiパネル)
  - [画像から翻訳（D&D / サムネイル選択 / 再翻訳）](#画像から翻訳dd--サムネイル選択--再翻訳)
  - [口調プリセット（かんたん/詳細 & ゲーム別）](#口調プリセットかんたん詳細--ゲーム別)
- [自由選択（ラッソ）での範囲指定](#自由選択ラッソでの範囲指定)
- [連結（複数画像の縦結合）と順序](#連結複数画像の縦結合と順序)
- [原文の保持とコピー](#原文の保持とコピー)
- [画像への併記保存（原文/訳文）](#画像への併記保存原文訳文)
  - [縦長画像は右側併記（自動/固定）](#縦長画像は右側併記自動固定)
- [外観と挙動のカスタマイズ（環境変数）](#外観と挙動のカスタマイズ環境変数)
  - [ROI枠・テキストボックス](#roi枠テキストボックス)
  - [外置きパネル](#外置きパネル)
  - [ヘルプ/編集ハンドル](#ヘルプ編集ハンドル)
  - [併記PNGの体裁](#併記pngの体裁)
  - [GUIコンパクト化/横幅・ボタン幅](#guiコンパクト化横幅ボタン幅)
  - [その他（モデル/動作）](#その他モデル動作)
- [保存物/ログ](#保存物ログ)
- [トラブルシュート](#トラブルシュート)
- [よく使う設定例](#よく使う設定例)
- [ファイル構成](#ファイル構成)
- [ライセンス](#ライセンス)

---

## 特徴
- 🖼 **ドラッグ選択 → 即翻訳**：画面の任意範囲をOCR → 日本語訳をオーバーレイ表示
- ✏️ **自由選択（ラッソ）**：Alt+Shift+C で任意多角形選択 → その**内側のみ**を切り出して翻訳
- ➕ **連結キャプチャ**：複数枚を**縦連結**し一括翻訳（UIや長文に便利）
- 🧰 **GUIパネル**：ボタン操作、**口調プリセット（かんたん/詳細・ゲーム別）**
- 🗣 **話者（黄枠）指定**：会話相手の枠を黄枠で指定、口調/話者名も指定
- 📥 **画像から翻訳**：GUIに**D&D**、または**サムネイル付き選択ダイアログ**から複数選択
- 🔁 **最後の保存から再翻訳**：1クリックで直近の保存画像を再投入
- ⏫ **前面固定（TopMost）**：オーバーレイ／パネルを一定間隔で最前面化
- ⏹ **キャンセル**：API呼び出し中でも**Alt+X**で即キャンセル（GUIでは実行中、**翻訳ボタンがキャンセルに切替**）
- 📋 **原文保持 & 右クリックコピー**：`{"source","ja"}`で受け取り、訳欄は**jaのみ**表示
- 🖼 **画像として保存**：訳文（＋原文）を**下側**または**右側**に併記したPNGを保存（手動/自動）
- 🎨 **外観カスタム**：枠色/太さ/角丸/余白、パネル配色、併記PNGの体裁、**パネル横幅/ボタン幅/高さ**を環境変数で変更

---

## 動作環境
- **OS**：Windows 10/11 推奨（グローバルホットキーの互換性）  
- **Python**：3.10 以上推奨  
- **依存**：`requirements.txt`（`PySide6`, `Pillow`, `mss`, `keyboard`, `requests`）

---

## インストール
```bash
# コマンドプロンプト
python -m venv .venv
.venv\Scripts\activate
pip install -r requirements.txt
```

---

## APIキー/モデルの設定
- `GEMINI_API_KEY` **または** `GOOGLE_API_KEY`（どちらでも可。Google AI StudioでAPIキーを取得）
- おすすめモデル例：`gemini-2.5-flash`（環境変数 `GEMINI_MODEL` で指定）

---

## 起動方法
### コマンドプロンプト例
```bat
cd /d D:\ScreenTranslate
.venv\Scripts\activate
set GEMINI_MODEL=gemini-2.5-flash
set OST_SAVE_CAPTURE=1
set OST_DEBUG=0
set OST_GUI_MODE=1  :: GUIパネルを使う
set OST_PREPROCESS=1
set OST_GUI_HOTKEYS=1  :: GUI中でもホットキーを有効に
set OST_SAVE_ANNOTATED=0
set OST_PRIMARY_ONLY=0
python ScreenTranslate.py
```
> **cmd.exe** は `set NAME=VALUE`（`=`前後にスペースを入れない）。

---

## 基本操作フロー
1. **範囲選択（矩形）**：Alt+C → ドラッグで青枠を作る（F10で編集モードON/OFF）  
2. **自由選択（ラッソ）**：Alt+Shift+C → 始点クリック→ドラッグで線描→ボタンを離すと自動で閉じて多角形に  
3. 必要なら**話者枠（黄）**：Alt+S → 話者名が出る欄などを選択（F11で編集）  
4. **翻訳（Alt+T）** → 訳文が内側/外置きパネルに表示  
5. 訳文エリア右クリック → **コピー**／**画像として保存（訳のみ / 原文＋訳文）**  
6. 画像素材がある場合は [画像から翻訳](#画像から翻訳dd--サムネイル選択--再翻訳) を利用

---

## ホットキー（既定）

| 操作 | 既定キー |
|---|---|
| 翻訳 | **Alt+T** |
| 範囲選択（矩形） | **Alt+C** |
| **自由選択（ラッソ）** | **Alt+Shift+C** |
| リーダーパネル 表示/非表示 | **Alt+R** |
| 口調ダイアログ | **Alt+K** |
| 話者ダイアログ | **Alt+F** |
| 話者枠の選択 | **Alt+S** |
| 話者クリア | **Ctrl+Shift+S** |
| 連結に追加（現在の青枠） | **Alt+A** |
| 連結クリア | **Alt+D** |
| 画像から翻訳（サムネイル選択） | **Alt+O** |
| 最後の保存から再翻訳 | **Alt+Shift+R** |
| フォント小/大 | **F1 / F2** |
| 訳文欄 低/高（高さ） | **F3 / F4** |
| CAPTURE FULL/EXCLUDE | **F5** |
| 隠す/隠さない（キャプチャ時） | **F6** |
| 外置き/内側（メッセージ位置） | **F7** |
| パネル追従（リセット） | **Shift+F7** |
| 青枠/黄枠 表示 | **F8 / F9** |
| 青枠/黄枠 編集モード | **F10 / F11** |
| 訳文欄 表示/非表示 | **Alt+Z** |
| **キャンセル** | **Alt+X** |
| **終了**（既定） | **Ctrl+Shift+F12** |

> GUIモード中も `OST_GUI_HOTKEYS=1` で上記ホットキーを有効化できます。

---

## GUIパネル

- 上段に **範囲 / 翻訳 /（実行中は）キャンセル** ボタン。翻訳実行中は**「翻訳」→「キャンセル」**に自動で切り替わります。  
- 中段に **口調 / 話者 / 話者枠 / 話者クリア**。  
- 下段（3段目）に **話者クリア / 画像から翻訳 / 最後の保存から再翻訳**。  
- 連結（Alt+A / Alt+D）、訳文欄の表示切替（Alt+Z）、パネル追従のリセット（Shift+F7）。  
- **前面固定（TopMost）** を定期的に適用して、他アプリの背後に回りにくくしています（アプリによっては前面を奪う場合あり）。

### 画像から翻訳（D&D / サムネイル選択 / 再翻訳）
- **ドラッグ＆ドロップ**：画像ファイル（.png/.jpg/.jpeg/.bmp/.webp/.gif）を**GUIパネルにD&D** → そのまま翻訳  
- **サムネイル選択**：**Alt+O** → サムネイル付きダイアログで複数選択→翻訳  
- **最後の保存から再翻訳**：**Alt+Shift+R** → `captures/used_main_*.png` または `captures/concat_*.png` を自動再投入  
- **複数画像**は**縦に連結**されて1枚として送られます（[順序](#連結複数画像の縦結合と順序) を参照）。

### 口調プリセット（かんたん/詳細 & ゲーム別）
- モード切替：**かんたん / 詳細**（UI上のプルダウン）  
- 対象：**デフォルト** または `tone_games/<ゲーム名>/` に保存した**ゲーム別プリセット**を選択  
- 保存/削除：ダイアログ右側のボタンでプリセットを追加・削除  
- 保存ファイル：
  - かんたん：`ost_tone_presets.json`
  - 詳細：`ost_tone_presets_v2.json`
  - ゲーム別：`tone_games/<GameName>/` に上記と同名で配置

---

## 自由選択（ラッソ）での範囲指定
- **Alt+Shift+C** → 画面が暗転 → **始点をクリックしてドラッグ** → ボタンを離すと始点に自動連結して多角形化  
- 以後のキャプチャは**多角形内側のみ**が対象（矩形ではありません）。  
- 通常の矩形選択（Alt+C）を行うと、ラッソ選択は解除されます。

---

## 連結（複数画像の縦結合）と順序
- 連結は、**Alt+A** で現在の青枠を追加、または **画像から翻訳**で複数選択/複数D&Dしたときに自動で行われます。  
- **結合順序は「更新日時順（古い → 新しい）」がデフォルト**です。  
- 幅の異なる画像は**横幅を基準**に縮尺調整して揃え、**区切り線**を入れて縦連結します。

---

## 原文の保持とコピー
- 出力は JSON 形式 `{"source":"OCRで認識した原文","ja":"自然な日本語訳"}` を期待します。  
- UIには **jaのみ**を表示し、原文は内部保持します。  
- 訳文欄の右クリックメニューから **訳文/原文/原文＋訳文のコピー** が可能です。

---

## 画像への併記保存（原文/訳文）
- 訳文（＋原文）を**下側**または**右側**に帯として併記し、PNGで保存します。  
- 自動保存は `OST_SAVE_ANNOTATED=1`、原文も併記する場合は `OST_ANN_INCLUDE_SRC=1`。

### 縦長画像は右側併記（自動/固定）
- 画像の**縦横比**に応じて `auto` で**右側帯**または**下側帯**を自動選択。  
- 強制指定も可能：`OST_ANN_LAYOUT=side|bottom`。

---

## 外観と挙動のカスタマイズ（環境変数）

### ROI枠・テキストボックス
| 変数 | 既定 | 説明 |
|---|---|---|
| `OST_BORDER_WIDTH` | `3` | 枠線の太さ(px) |
| `OST_BORDER_COLOR` | `#00D2FF` | 青枠色（`#RRGGBB[AA]` または `r,g,b[,a]`） |
| `OST_SPEAKER_COLOR` | `255,210,0,220` | 黄枠色 |
| `OST_TEXT_BG` / `OST_TEXT_FG` | `20,20,20,180` / `240,240,240,255` | 訳欄の背景/文字色 |
| `OST_TEXT_ROUND` | `8` | 訳欄の角丸(px) |
| `OST_TEXT_MARGIN` | `10` | ROI内側の余白(px) |
| `OST_TEXT_PADDING_X` / `OST_TEXT_PADDING_Y` | `12` / `8` | 文字パディング(px) |

### 外置きパネル
| 変数 | 既定 | 説明 |
|---|---|---|
| `OST_MSG_OUTSIDE` | `1` | 訳欄を外置きパネルにする |
| `OST_TEXT_RATIO` | `0.28` | ROIに対する訳欄高さ比（内側表示時） |
| `OST_PANEL_TEXT_PADDING` | `8` | パネル内テキストのパディング(px) |
| `OST_PANEL_BG` / `OST_PANEL_BORDER` | `20,20,20,200` / `0,210,255,180` | パネルの色 |
| `OST_PANEL_MIN_W` / `OST_PANEL_MIN_H` | `280` / `160` | パネル最小サイズ |
| `OST_GUI_MODE` | `0` | GUIパネルのON/OFF |
| `OST_GUI_HOTKEYS` | `0` | GUI中でもホットキーを受付ける |
| `OST_GUI_COMPACT` | `1` | コンパクトモード |
| `OST_GUI_PANEL_W` | `720` | パネル幅(px) |
| `OST_GUI_BTN_W` / `OST_GUI_BTN_H` | `0` / `28` | ボタン幅(px,0はauto)/高さ(px) |
| `OST_GUI_SPACING` / `OST_GUI_MARGINS` | `6` / `6,6,6,6` | 余白 |

> コンパクトON時はボタンの `padding` も軽く圧縮（`2px 6px`）。

### ヘルプ/編集ハンドル
| 変数 | 既定 | 説明 |
|---|---|---|
| `OST_HANDLE_SIZE` | `12` | ハンドルのサイズ |
| `OST_HANDLE_HOT` | `6` | ハンドルの当たり拡張(px) |
| `OST_ROI_AUTO_EDIT` | `1` | 枠上ホバーでハンドルを使える |
| `OST_ROI_BORDER_MOVE` | `1` | 枠の縁ドラッグで移動 |
| `OST_ROI_AUTO_MOVE` | `0` | ROI内部ドラッグで移動許可 |
| `OST_MOVE_BAND` | `8` | 「縁」と判定する帯幅(px) |

### 併記PNGの体裁
| 変数 | 既定 | 説明 |
|---|---|---|
| `OST_SAVE_ANNOTATED` | `0` | 訳文画像を自動保存 |
| `OST_ANN_INCLUDE_SRC` | `0` | 併記に原文も含める |
| `OST_ANN_LAYOUT` | `auto` | `auto`/`side`/`bottom` |
| `OST_ANN_SIDE_THRESHOLD` | `1.6` | 高さ/幅がこの比を超えると横帯 |
| `OST_ANN_SIDE_WIDTH` | `420` | 右帯の幅(px) |
| `OST_ANN_MARGIN` / `OST_ANN_PAD` / `OST_ANN_GAP` | `16` / `12` / `10` | レイアウト余白 |

### その他（モデル/動作）
| 変数 | 既定 | 説明 |
|---|---|---|
| `GEMINI_MODEL` | `gemini-2.5-flash` | 使用モデル |
| `OST_KEEP_SOURCE` | `1` | `{"source","ja"}` を想定し原文保持 |
| `OST_FONT_PT` | `12` | UIフォントpt |
| `OST_CAPTURE_FULL` | `1` | 0で訳欄部分をキャプチャから除外 |
| `OST_HIDE_ON_CAPTURE` | `1` | キャプチャ瞬間にUIを隠す |
| `OST_SAVE_CAPTURE` | `0` | 送信実画像を保存（`used_main_*.png` ほか） |
| `OST_CONCAT_MAX` | `8` | 連結の最大枚数 |
| `OST_CONCAT_GAP` | `6` | 連結の区切り線の厚み(px) |
| `OST_CONCAT_MODE` | `L` | 連結キャンバスのモード（`L`/`RGB`） |
| `OST_PRIMARY_ONLY` | `0` | 1でプライマリ画面のみ対象 |
| `OST_POLL` | `1` | VKポーリング（Win32） |
| `OST_EXIT_HOTKEY` | `ctrl+shift+f12` | 終了ホットキー |

---

## 保存物/ログ
- `captures/concat_current.png` … 連結プレビュー（翻訳完了時に日付名で退避）  
- `captures/annotated_*.png` … 併記保存ファイル（手動/自動）  
- `captures/used_main_*.png` / `used_speaker_*.png` … 送信用実画像（必要時のみ）  
- `captures/history.tsv` … `timestamp \t source \t ja` を追記（原文保持ON時）

---

## トラブルシュート
- **「APIキー未設定」** → `GEMINI_API_KEY` **または** `GOOGLE_API_KEY` を設定  
- **ホットキーが効かない** → 権限/他アプリと衝突の可能性。管理者実行や `OST_GUI_HOTKEYS=1` を試す  
- **うまくOCRできない／文字が薄い** → `OST_PREPROCESS=1` で前処理、枠をタイトに、解像度を上げる、**連結**する  
- **訳が途中で途切れる/返答がブレる** → `KEEP_SOURCE=1` でJSON厳格化（既定）。「詳細」口調は長文になりやすいので、必要に応じて簡潔なプリセットを使用  
- **ウィンドウが背面に回る** → 前面固定は定期適用していますが、アプリによっては前面を奪います。`Shift+F7`でパネル追従をリセット

---

## よく使う設定例

### 右側併記＋訳文を大きめに
```powershell
$env:OST_ANN_LAYOUT = 'side'
$env:OST_ANN_SIDE_WIDTH = '480'
$env:OST_ANN_FONT_JA_PT = '20'
python .\ScreenTranslate.py
```

### 見た目を濃く・角丸に
```bat
set OST_BORDER_COLOR=#00D2FF
set OST_BORDER_WIDTH=4
set OST_TEXT_BG=0,0,0,200
set OST_TEXT_ROUND=12
python ScreenTranslate.py
```

### パネルをコンパクト＆狭幅＋ボタン幅固定
```powershell
$env:OST_GUI_MODE = '1'
$env:OST_GUI_COMPACT = '1'
$env:OST_GUI_PANEL_W = '560'
$env:OST_GUI_BTN_W = '150'
$env:OST_GUI_BTN_H = '24'
$env:OST_GUI_SPACING = '4'
$env:OST_GUI_MARGINS = '4,4,4,4'
python .\ScreenTranslate.py
```

---

## ファイル構成
- `ScreenTranslate.py` … メイン（最新）
- `requirements.txt` … 依存
- `captures/` … 各種保存物（キャプチャ/併記画像/履歴）
- `ost_tone_presets.json` / `ost_tone_presets_v2.json` … 口調プリセット（かんたん/詳細）
- `tone_games/<GameName>/` … ゲーム別プリセット格納先

---

## ライセンス
プロジェクト方針に合わせて選択してください（例：MIT）。

---

## 追加: 現状の仕様メモ（2025-10-15 02:14:29 更新）

### RECITATION 対策（自動再翻訳 & 見える化）
- **挙動**: 有名/既知の本文と判定され `finishReason=RECITATION` になった場合、まず **`{"ja"} のみ**で自動再試行します。さらに同じ理由で止まった場合は、**画像を縦に分割**して各タイルを **`{"ja"} のみ**で翻訳し、**結合**して表示します。
- **UI表示**（訳文欄に一時表示）:
  - 「**（有名/既知の本文と判定され出力が停止されたため、訳文のみで再翻訳しています…）**」
  - 「**（依然として出力が停止されたため、画像を分割して再翻訳しています…）**」
- **環境変数**:
  - `OST_KEEP_SOURCE=0` … もともと **訳文のみ**で問い合わせ（RECITATIONに強い）
  - `OST_RECITATION_AUTO=1` … RECITATION 検知時に **訳文のみ**へフォールバック（既定=1）
  - `OST_SLICE_ON_RECITATION=1` … 訳文のみでも止まる場合に **自動分割**（既定=1）
  - `OST_SLICE_PARTS=3` … 分割数（2以上）。**大きいほど回避しやすい**が、その分リクエストが増えます。

> 実装上、**分割した画像そのものをAPIへ送信**するよう修正済みです（`build_payload()/request_once()` が画像引数を取り、スライスごとに送ります）。これにより「分割しても効果がない」問題を解消しています。 fileciteturn26file1

### ビジー時の入力制御
- 翻訳実行中は **キャンセル（Alt+X）と終了ホットキー**のみ受け付け、**その他のホットキーは一時的に無効化**します。
- GUIでは実行中、**「翻訳(ALT+T)」ボタンが「キャンセル(Alt+X)」に差し替わり**、クリックで即中断できます。 fileciteturn26file1

### サムネイル選択ダイアログの並び順と処理順
- ダイアログ表示は **新しい → 古い（降順）**で並び替え、選びやすくしています。
- 実際の連結・送信は **更新日時の「古い → 新しい」順**で結合して送ります（既定）。 fileciteturn26file1

### 自由選択（ラッソ）の切り抜き品質
- 多角形で囲った内側だけをマスクして切り出し、**わずかなガウスぼかし**でエッジをなじませています（`GaussianBlur(0.8)`）。
- その後、従来と同じ **前処理（輝度/コントラスト/シャープネス）**を適用します（`OST_PREPROCESS=1` 既定）。 fileciteturn26file1

### 前面固定（TopMost）
- オーバーレイ / 操作パネル / メッセージパネルを **1.5秒周期で最前面化**します。アプリによっては前面を奪うため、絶対ではありません（例: 一部の描画系アプリ）。 fileciteturn26file1

### 画像から翻訳（D&D / Alt+O / 再翻訳）
- **GUIへドラッグ＆ドロップ**で直接翻訳。**Alt+O** では **サムネイル付きダイアログ**で複数選択可能です。
- **Alt+Shift+R** で `captures/used_main_*.png` あるいは `concat_*.png` を自動検出して **再翻訳**します。再投入時は訳欄に「(再翻訳: ファイル名)」と出ます。 fileciteturn26file1

### 連結プレビューと保存
- 連結キューに画像を追加すると `captures/concat_current.png` を生成し、翻訳完了時に **タイムスタンプ名へ退避**します。  
- 併記保存（訳文のみ / 原文＋訳文）は **下帯 or 右帯**。右帯で入り切らない場合は自動で下帯へフォールバックします。折り返しは `textlength()/bbox` で正確化。 fileciteturn26file1

### ホットキー（GUIモードでも使う）
- `OST_GUI_HOTKEYS=1` で **GUI表示中でも Alt+T / Alt+C などのホットキーを有効化**します。 fileciteturn26file1

### 既知の制約と回避策（RECITATION関連）
- **本文ページ丸ごと**のような長い連続テキストでは、訳文のみ/分割でもブロックされる場合があります。  
  - `OST_KEEP_SOURCE=0`（最初から訳文のみ）  
  - `OST_SLICE_PARTS=6` 以上へ上げる  
  - それでも厳しい場合は **ローカルOCR→文単位の訳文のみ翻訳**への切り替えを検討してください（将来の拡張候補）。

